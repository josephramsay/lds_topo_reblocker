---

################################################################################
#
# Copyright 2013 Crown copyright (c)
# Land Information New Zealand and the New Zealand Government.
# All rights reserved
#
# This program is released under the terms of the new BSD license. See the
# LICENSE file for more information.
#
################################################################################

#
### DATABASE SERVICE TESTS ###
#

- name: Create a unique test ID
  shell: >
    date +"%s"
  register: test_id_sum

- name: Set a unique test ID
  set_fact:
    test_id: "{{ test_id_sum.stdout|trim }}"


### POSTGRESQL
- name: Test if PostgreSQL is up and running
  shell: >
    psql
    -v ON_ERROR_STOP=yes
    -tAc "SELECT version()"
  become: yes
  become_user: postgres


- name: Detect WAL files directory (pg_xlog) information
  stat:
    path: /store/postgresql/pg_xlog
  register: test_xlog_dir
  become: yes

- name: Test if WAL files directory (pg_xlog) is symlink
  assert:
    that:
      - test_xlog_dir.stat.islnk
        and
        test_xlog_dir.stat.lnk_source == '/store/postgresql_xlog'


### REBLOCKER
- name: Create linz database
  postgresql_db:
    name: "{{ rbk_db }}"
    encoding: 'UTF-8'
    template: template_postgis
    state: present
  become: yes
  become_user: postgres
  
# Install reblocker sql
- name: Insert reblocker functions
  shell: >
    psql
    -v ON_ERROR_STOP=yes
    -d {{ rbk_db }}
    -f {{ neighbour_func }}
  args:
    executable: /bin/bash
  become: yes
  become_user: postgres
  
- name: Insert topoview functions
  shell: >
    psql
    -v ON_ERROR_STOP=yes
    -d {{ rbk_db }}
    -f {{ topoview_func }}
  args:
    executable: /bin/bash
  become: yes
  become_user: postgres




